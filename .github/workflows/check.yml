
name: Validate DNS records

on:
  pull_request:
  
jobs:
  check:
    name: Run `octodns-sync` with config.yaml
    runs-on: ubuntu-latest
    outputs:
      plan: ${{ steps.generate-plan.outputs.plan }}
    steps:
      - uses: actions/checkout@v2
      - uses: solvaholic/octodns-sync@v2.3.0
        id: generate-plan
        with:
          config_path: config.yaml
        env:
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
          CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
  add-pr-comment:
    name: Comment the migration plan
    needs: [check]
    runs-on: ubuntu-latest
    steps:
      - name: Find previous comment, if present
        uses: peter-evans/find-comment@v1.2.0
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: github-actions[bot]
          body-includes: Automatically generated by octodns-sync
      - name: Create or update comment
        id: prcomment
        uses: peter-evans/create-or-update-comment@v1.4.5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body: |
            ${{ needs.check.outputs.plan }}

            Automatically generated by octodns-sync
          edit-mode: replace
